<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client RESTfull WS</title>
</head>

<body>
    <div>
        <h1>Lista utenti</h1>
        <ul id="persons"></ul>
    </div>
    <div>
        <h2 id="person"></h2>
        <div id="detail"></div>
    </div>
    <div>
        <h2>Iserisci utente</h2>
        <form id="formInsert">
            <input type="text" name="firstname" id="firstname" placeholder="nome">
            <input type="text" name="lastname" id="lastname" placeholder="cognome">
            <button id="addButton">Salva</button>
        </form>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.8/axios.min.js"></script>
    <script>
        
        let endpoint = 'https://danilofolli.alwaysdata.net';
        let persons = [];

        // Generazione della lista
        function getlist() {
            fetch(endpoint + '/person')
                .then(response => response.json())
                .then(data => {
                    console.log(data)
                    let person = document.getElementById('persons');
                    data.forEach(element => {
                        persons[element.id] = {
                            "name": element.firstname, 
                            "surname": element.lastname
                        }
                        el_li = document.createElement('li');
                        el_li.innerHTML = element.id + ' - ' + element.firstname + ' ' + element.lastname;
                        el_li.id = 'p' + element.id;
                        el_li.onclick = function() { 
                            getDetail(element.id)
                        };
                        person.appendChild(el_li);                       
                    });
                })
                .catch(error => console.error(error));
        }

        // Generazione della scheda
        function getDetail( id ) {
            fetch( endpoint + '/person/' + id)
                .then(response => response.json())
                .then(data => {
                    // console.log(data)
                    // console.log(persons[data[0].firstparent_id].name)
                    let detail = document.getElementById('detail');
                    let person = document.getElementById('person');
                     if(data[0].firstparent_id > 0 && data[0].secondparent_id > 0 ) { 
                        person.innerHTML = 'Parenti di ' + data[0].firstname + ' ' + data[0].lastname
                        var pp = persons[data[0].firstparent_id].name + ' ' + persons[data[0].firstparent_id].surname
                        var sp = persons[data[0].secondparent_id].name + ' ' + persons[data[0].secondparent_id].surname
                        detail.innerHTML = 'Primo parente: ' + pp + ' - secondo parente: ' + sp
                    } else {
                        person.innerHTML = 'Nessun parente'
                        detail.innerHTML = ''
                    }
                })
        }

        function generateSuccessHTMLOutput(response) {
            return  '<h4>Result</h4>' + 
                    '<h5>Status:</h5> ' + 
                    '<pre>' + response.status + ' ' + response.statusText + '</pre>' +
                    '<h5>Headers:</h5>' + 
                    '<pre>' + JSON.stringify(response.headers, null, '\t') + '</pre>' + 
                    '<h5>Data:</h5>' + 
                    '<pre>' + JSON.stringify(response.data, null, '\t') + '</pre>'; 
          }
          function generateErrorHTMLOutput(error) {
            return  '<h4>Result</h4>' + 
                    '<h5>Message:</h5> ' + 
                    '<pre>' + error.message + '</pre>' +
                    '<h5>Status:</h5> ' + 
                    '<pre>' + error.response.status + ' ' + error.response.statusText + '</pre>' +
                    '<h5>Headers:</h5>' + 
                    '<pre>' + JSON.stringify(error.response.headers, null, '\t') + '</pre>' + 
                    '<h5>Data:</h5>' + 
                    '<pre>' + JSON.stringify(error.response.data, null, '\t') + '</pre>'; 
          }
          
        document.getElementById("addButton").addEventListener("click", function(e) {
            
            e.preventDefault();

            const user = {
                'firstname' : document.getElementById("firstname").value,
                'lastname' : document.getElementById("lastname").value,
            }
            console.log(user);

            // chiamata con vanilla javascript 
            /**/ 
            fetch( endpoint + '/person', {
                    method: 'POST',
                    headers: {
                        'Accept': 'application.json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(user)
                })
                .then(response => response.json())
                .then(data => {
                    console.log(data)   
                })           
                .catch(error => {
                    //handle error
                });
            /**/

            // chiamata con libreria AXIOS
            /*
            axios.post( endpoint + '/person', user)
              .then(function (response) {
                // resultElement.innerHTML = generateSuccessHTMLOutput(response);
                console.log(response) 
              })
              .catch(function (error) {
                // resultElement.innerHTML = generateErrorHTMLOutput(error);
              });
            */
        })

        // Avvio
        getlist();

    </script>
</body>

</html>